# textlintã§ã®æ–‡æ³•ãƒã‚§ãƒƒã‚¯ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
name: Lint-fix

# Reviewdogã§ã®æŒ‡æ‘˜ã‚’æœ‰åŠ¹ã«ä½¿ã†ãŸã‚ã€pull requestã§ã®ã¿æœ‰åŠ¹
on:
  workflow_dispatch:  
  pull_request:
    # Pull Requestã‹ã¤
    # ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã€ã“ã®Workflowã‚’å®Ÿè¡Œ
    paths:
      - "prh.yml"
      - ".textlintrc"
      - "package.json"
      - "package-lock.json"
      - ".github/workflows/lint.yaml"
      - "**.tex"

jobs:
  lint:
    permissions:
      checks: write
      contents: write
      pull-requests: write
      actions: read 
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: 
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Setup node environment
        uses: actions/setup-node@v4
        with:
          cache: npm
          node-version: "20.x"

      - uses: reviewdog/action-setup@v1
        with:
          reviewdog_version: latest

      # ä¾å­˜é–¢ä¿‚ã®æ§‹ç¯‰ã¨textlintã®å®Ÿè¡Œ
      - name: Run lint
        id: lint-check 
        run: |
          npm install
          npm run lint
        continue-on-error: true

      # â†‘ã®ã‚¹ãƒ†ãƒƒãƒ—ã§textlintãŒé•åã‚’æ¤œçŸ¥ã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
      - name: Run reviewdog
        if: steps.lint-check.outcome == 'failure'
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm run --silent lint-style | reviewdog -f=checkstyle -name="textlint" -diff="git diff HEAD^" -reporter=github-pr-review

      - name: Auto-fix and commit textlint errors
        if:  steps.lint-check.outcome == 'failure'
        id: auto-fix 
        run: |
          npm run fix
          if git diff --quiet; then
            echo "fixed=false" >> $GITHUB_OUTPUT
          else
            echo "fixed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit fixes
        if:  steps.lint-check.outcome == 'failure' && steps.auto-fix.outputs.fixed == 'true'
        uses: EndBug/add-and-commit@v9
        with:
          author_name: github-actions
          author_email: github-actions@github.com
          message: 'fix: auto-fix textlint errors'
          add: 'sections/'
          #branch: ${{ github.ref_name }}

      # è‡ªå‹•ä¿®æ­£ã®çµæœã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
      - name: Report auto-fix results
        if:  steps.lint-check.outcome == 'failure' && steps.auto-fix.outputs.fixed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_COMMIT=$(git rev-parse HEAD)
          NEW_COMMIT_SHORT=$(git rev-parse --short HEAD)
          COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s")
    
          echo "ğŸ“Š Reporting commit details..."
    
          gh pr comment ${{ github.event.number }} --body "**Auto-fix Commit Created**

          æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸ
          - ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥: [\`$NEW_COMMIT_SHORT\`](https://github.com/${{ github.repository }}/commit/$NEW_COMMIT)
          - ä½œæˆæ™‚åˆ»: $(date -u '+%Y-%m-%d %H:%M:%S UTC')ã€€" 
      
